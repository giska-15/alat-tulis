---
import AdminLayout from "../../layouts/AdminLayout.astro";
---

<AdminLayout title="Produk" active="products">
	<div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
		<div class="flex items-center gap-4">
			<h1 class="text-lg font-semibold">Daftar Produk</h1>
			<div class="hidden sm:flex">
				<div class="flex flex-col gap-1">
					<span class="text-[10px] font-medium text-zinc-500">Kategori</span>
					<select id="category" class="h-8 w-16 rounded-lg border border-zinc-200 bg-white px-3 text-xs text-zinc-700">
					<option value="">0</option>
				</select>
				</div>
			</div>
		</div>
		<div class="flex items-center gap-3">
			<div class="rounded-xl border border-zinc-200 bg-white px-4 py-2">
				<p class="text-[10px] text-zinc-500">Kategori</p>
				<div class="mt-0.5 flex items-center gap-2">
					<div class="grid h-7 w-7 place-items-center rounded-full bg-red-50 text-red-600">
						<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M20 7h-9" />
							<path d="M14 17H5" />
							<circle cx="17" cy="17" r="3" />
							<circle cx="7" cy="7" r="3" />
						</svg>
					</div>
					<p id="stat-categories" class="text-base font-semibold leading-none">-</p>
				</div>
			</div>
			<div class="rounded-xl border border-zinc-200 bg-white px-4 py-2">
				<p class="text-[10px] text-zinc-500">Total produk</p>
				<div class="mt-0.5 flex items-center gap-2">
					<div class="grid h-7 w-7 place-items-center rounded-full bg-red-50 text-red-600">
						<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
							<path d="M3.3 7l8.7 5 8.7-5" />
							<path d="M12 22V12" />
						</svg>
					</div>
					<p id="stat-products" class="text-base font-semibold leading-none">-</p>
				</div>
			</div>
			<button id="btn-add" class="inline-flex items-center gap-2 rounded-xl border border-zinc-200 bg-white px-4 py-2 text-[13px] font-semibold hover:bg-zinc-50">
				<span class="grid h-7 w-7 place-items-center rounded-full bg-red-50 text-red-600">
					<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M12 5v14" />
						<path d="M5 12h14" />
					</svg>
				</span>
				Tambah Produk
			</button>
		</div>
	</div>

	<div class="mt-4 overflow-x-auto">
		<table class="min-w-full text-xs">
			<thead>
				<tr class="bg-zinc-100 text-left text-[10px] uppercase tracking-wide text-zinc-500">
					<th class="rounded-l-xl px-4 py-3">Info Produk</th>
					<th class="px-4 py-3">Kategori</th>
					<th class="px-4 py-3">Harga</th>
					<th class="px-4 py-3">Stock</th>
					<th class="rounded-r-xl px-4 py-3 text-right">Aksi</th>
				</tr>
			</thead>
			<tbody id="body"></tbody>
		</table>
		<p id="empty" class="mt-4 hidden text-sm text-zinc-500">Belum ada data.</p>
		<p id="error" class="mt-4 hidden text-sm text-red-600"></p>
	</div>

	<dialog id="dlg" class="w-full max-w-2xl rounded-2xl p-0">
		<form method="dialog" class="rounded-2xl bg-white">
			<div class="border-b border-zinc-200 px-5 py-4">
				<p id="dlg-title" class="text-sm font-semibold">Tambah Produk</p>
				<p class="text-xs text-zinc-500">Edit = hapus + tambah (ID akan berubah).</p>
			</div>
			<div class="grid gap-3 px-5 py-4 sm:grid-cols-2">
				<label class="text-sm sm:col-span-2">
					<span class="text-xs text-zinc-600">Nama</span>
					<input name="name" required class="mt-1 w-full rounded-lg border border-zinc-200 px-3 py-2 text-sm" />
				</label>
				<label class="text-sm">
					<span class="text-xs text-zinc-600">Harga (angka)</span>
					<input name="price" type="number" min="0" step="1" required class="mt-1 w-full rounded-lg border border-zinc-200 px-3 py-2 text-sm" />
				</label>
				<label class="text-sm">
					<span class="text-xs text-zinc-600">Stok (opsional)</span>
					<input name="stock" type="number" min="0" step="1" class="mt-1 w-full rounded-lg border border-zinc-200 px-3 py-2 text-sm" />
				</label>
				<label class="text-sm sm:col-span-2">
					<span class="text-xs text-zinc-600">Category</span>
					<select name="categoryId" required class="mt-1 w-full rounded-lg border border-zinc-200 px-3 py-2 text-sm"></select>
				</label>
			</div>
			<input type="hidden" name="__mode" value="create" />
			<input type="hidden" name="__originalId" value="" />
			<p id="form-error" class="px-5 pb-2 text-sm text-red-600"></p>
			<div class="flex items-center justify-end gap-2 border-t border-zinc-200 px-5 py-4">
				<button type="button" data-cancel class="rounded-lg border border-zinc-200 bg-white px-4 py-2 text-sm hover:bg-zinc-50">Batal</button>
				<button type="submit" class="rounded-lg bg-zinc-900 px-4 py-2 text-sm font-medium text-white hover:bg-zinc-800">Simpan</button>
			</div>
		</form>
	</dialog>

	<script type="module">
		import {
			fetchProducts,
			fetchCategoriesSearch,
			createProduct,
			deleteProduct,
			formatRupiah,
		} from "/admin-api.js";

		const tbody = document.getElementById("body");
		const emptyEl = document.getElementById("empty");
		const errEl = document.getElementById("error");
		const qEl = null;
		const categoryEl = document.getElementById("category");
		const dlg = document.getElementById("dlg");
		const formErr = document.getElementById("form-error");
		const dlgTitle = document.getElementById("dlg-title");
		const statCategories = document.getElementById("stat-categories");
		const statProducts = document.getElementById("stat-products");
		let productsById = new Map();

		const ICON_EDIT = `
			<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M12 20h9" />
				<path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" />
			</svg>
		`;
		const ICON_TRASH = `
			<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M3 6h18" />
				<path d="M8 6V4h8v2" />
				<path d="M19 6l-1 14H6L5 6" />
				<path d="M10 11v6" />
				<path d="M14 11v6" />
			</svg>
		`;

		function showError(message) {
			errEl.textContent = message;
			errEl.classList.remove("hidden");
		}
		function clearError() {
			errEl.textContent = "";
			errEl.classList.add("hidden");
		}

		function closestFromEvent(e, selector) {
			const t = e?.target;
			const el = t && t.nodeType === 3 ? t.parentElement : t;
			return el && el.closest ? el.closest(selector) : null;
		}

		function renderRows(rows) {
			tbody.innerHTML = "";
			productsById = new Map(rows.map((p) => [String(p.id), p]));
			statProducts.textContent = String(rows.length);
			for (const p of rows) {
				const tr = document.createElement("tr");
				tr.innerHTML = `
					<td class="border-b border-zinc-100 px-4 py-3">
						<div class="flex items-center gap-3">
							<div class="grid h-9 w-9 place-items-center rounded-lg bg-zinc-100">
								<svg class="h-4 w-4 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<path d="M12 5v14" />
									<path d="M5 12h14" />
								</svg>
							</div>
							<div class="min-w-0">
								<p class="truncate text-[12px] font-semibold text-zinc-900">${p.name}</p>
								<p class="text-[10px] text-zinc-500">ID: ${p.id}</p>
							</div>
						</div>
					</td>
					<td class="border-b border-zinc-100 px-4 py-3 text-zinc-700">${p.category?.name ?? "-"}</td>
					<td class="border-b border-zinc-100 px-4 py-3">${formatRupiah(p.price)}</td>
					<td class="border-b border-zinc-100 px-4 py-3">${p.stock ?? "-"}</td>
					<td class="border-b border-zinc-100 px-4 py-3 text-right">
						<div class="inline-flex items-center gap-3">
							<button title="Edit" data-edit="${p.id}" class="text-zinc-700 hover:text-zinc-900">${ICON_EDIT}</button>
							<button title="Hapus" data-del="${p.id}" class="text-red-600 hover:text-red-700">${ICON_TRASH}</button>
						</div>
					</td>
				`;
				tbody.appendChild(tr);
			}
			emptyEl.classList.toggle("hidden", rows.length !== 0);
		}

		async function load() {
			clearError();
			const q = "";
			const categoryId = String(categoryEl.value || "").trim();
			try {
				const rows = await fetchProducts({
					q: q || undefined,
					categoryId: categoryId || undefined,
					limit: 500,
				});
				renderRows(rows);
			} catch (e) {
				showError(e?.message ?? String(e));
			}
		}

		async function loadCategories() {
			try {
				const cats = await fetchCategoriesSearch();
				statCategories.textContent = String(cats.length);

				categoryEl.innerHTML = "";
				const opt0 = document.createElement("option");
				opt0.value = "";
				opt0.textContent = "0";
				categoryEl.appendChild(opt0);
				for (const c of cats) {
					const opt = document.createElement("option");
					opt.value = c.id;
					opt.textContent = c.id;
					categoryEl.appendChild(opt);
				}

				const select = dlg.querySelector("select[name=categoryId]");
				select.innerHTML = "";
				for (const c of cats) {
					const opt = document.createElement("option");
					opt.value = c.id;
					opt.textContent = `${c.id} - ${c.name}`;
					select.appendChild(opt);
				}
			} catch (e) {
				showError(e?.message ?? String(e));
			}
		}

		// search+refresh intentionally omitted (match reference UI)
		categoryEl.addEventListener("change", load);

		document.getElementById("btn-add").addEventListener("click", () => {
			dlgTitle.textContent = "Tambah Produk";
			formErr.textContent = "";
			dlg.querySelector('input[name="__mode"]').value = "create";
			dlg.querySelector('input[name="__originalId"]').value = "";
			dlg.showModal();
		});

		dlg.querySelector("[data-cancel]")?.addEventListener("click", () => {
			formErr.textContent = "";
			dlg.close("cancel");
		});

		dlg.addEventListener("close", () => {
			formErr.textContent = "";
			dlgTitle.textContent = "Tambah Produk";
			const form = dlg.querySelector("form");
			form?.reset();
			const mode = dlg.querySelector('input[name="__mode"]');
			const originalId = dlg.querySelector('input[name="__originalId"]');
			if (mode) mode.value = "create";
			if (originalId) originalId.value = "";
		});

		dlg.querySelector("form").addEventListener("submit", async (e) => {
			e.preventDefault();
			formErr.textContent = "";
			const fd = new FormData(e.currentTarget);
			const mode = String(fd.get("__mode") || "create");
			const originalId = String(fd.get("__originalId") || "").trim();
			const rawStock = String(fd.get("stock") || "").trim();
			const input = {
				name: String(fd.get("name") || "").trim(),
				price: Number(fd.get("price") || 0),
				stock: rawStock === "" ? null : Number(rawStock),
				categoryId: String(fd.get("categoryId") || "").trim(),
			};
			try {
				if (mode === "edit" && originalId) {
					await deleteProduct(Number(originalId));
				}
				await createProduct(input);
				dlg.close();
				await load();
			} catch (err) {
				formErr.textContent = err?.message ?? String(err);
			}
		});

		tbody.addEventListener("click", async (e) => {
			const delBtn = closestFromEvent(e, "button[data-del]");
			if (delBtn) {
				const id = Number(delBtn.getAttribute("data-del"));
				if (!id) return;
				if (!confirm(`Hapus produk #${id}?`)) return;
				try {
					await deleteProduct(id);
					await load();
				} catch (err) {
					showError(err?.message ?? String(err));
				}
				return;
			}

			const editBtn = closestFromEvent(e, "button[data-edit]");
			if (editBtn) {
				const id = String(editBtn.getAttribute("data-edit") || "");
				if (!id) return;
				const p = productsById.get(id);
				if (!p) return;
				dlgTitle.textContent = "Edit Produk";
				formErr.textContent = "";
				dlg.querySelector('input[name="__mode"]').value = "edit";
				dlg.querySelector('input[name="__originalId"]').value = id;
				dlg.querySelector('input[name="name"]').value = p.name;
				dlg.querySelector('input[name="price"]').value = String(p.price ?? 0);
				dlg.querySelector('input[name="stock"]').value = p.stock == null ? "" : String(p.stock);
				dlg.querySelector('select[name="categoryId"]').value = p.category?.id ?? p.categoryId ?? "";
				dlg.showModal();
			}
		});

		await loadCategories();
		await load();
	</script>
</AdminLayout>
