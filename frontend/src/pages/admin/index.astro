---
import AdminLayout from "../../layouts/AdminLayout.astro";
---

<AdminLayout title="Dashboard" active="dashboard">
	<div class="flex items-center justify-between">
		<div>
			<h1 class="text-lg font-semibold">Dashboard</h1>
		</div>
	</div>

	<div class="mt-5 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
		<div class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
			<div class="flex items-start justify-between">
				<div>
					<p class="text-[11px] text-zinc-500">Revenue</p>
					<p id="stat-revenue" class="mt-1 text-sm font-semibold">-</p>
				</div>
				<div class="grid h-9 w-9 place-items-center rounded-full bg-red-50 text-red-600">
					<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M12 1v22" />
						<path d="M17 5H9.5a3.5 3.5 0 0 0 0 7H14a3.5 3.5 0 0 1 0 7H6" />
					</svg>
				</div>
			</div>
		</div>
		<div class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
			<div class="flex items-start justify-between">
				<div>
					<p class="text-[11px] text-zinc-500">Total transaksi</p>
					<p id="stat-sales" class="mt-1 text-sm font-semibold">-</p>
				</div>
				<div class="grid h-9 w-9 place-items-center rounded-full bg-red-50 text-red-600">
					<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M9 11l3 3L22 4" />
						<path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
					</svg>
				</div>
			</div>
		</div>
		<div class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
			<div class="flex items-start justify-between">
				<div>
					<p class="text-[11px] text-zinc-500">Produk terjual</p>
					<p id="stat-sold" class="mt-1 text-sm font-semibold">-</p>
				</div>
				<div class="grid h-9 w-9 place-items-center rounded-full bg-red-50 text-red-600">
					<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
						<path d="M3.3 7l8.7 5 8.7-5" />
						<path d="M12 22V12" />
					</svg>
				</div>
			</div>
		</div>
		<div class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
			<div class="flex items-start justify-between">
				<div>
					<p class="text-[11px] text-zinc-500">Total profit</p>
					<p id="stat-profit" class="mt-1 text-sm font-semibold">-</p>
				</div>
				<div class="grid h-9 w-9 place-items-center rounded-full bg-red-50 text-red-600">
					<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M3 3v18h18" />
						<path d="M7 14l4-4 3 3 6-6" />
					</svg>
				</div>
			</div>
		</div>
	</div>

	<div class="mt-6 rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
		<div class="flex items-center justify-between">
			<p class="text-sm font-semibold">Top 10 Best Selling Products</p>
			<button class="text-zinc-400">⋮</button>
		</div>
		<div class="mt-3 overflow-x-auto">
			<table class="min-w-full text-xs">
				<thead>
					<tr class="bg-zinc-100 text-left text-[10px] uppercase tracking-wide text-zinc-500">
						<th class="rounded-l-xl px-4 py-3">Product Name</th>
						<th class="rounded-r-xl px-4 py-3 text-right">#</th>
					</tr>
				</thead>
				<tbody id="best-body"></tbody>
			</table>
		</div>
		<p id="dash-error" class="mt-3 hidden text-sm text-red-600"></p>
	</div>

	<div class="mt-6 space-y-4">
		<div class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
			<div class="flex items-center justify-between">
				<p class="text-sm font-semibold">Monthly Sales Profit 2025</p>
				<button class="text-zinc-400">⋮</button>
			</div>
			<div class="mt-3 overflow-x-auto">
				<table class="min-w-full text-xs">
					<thead>
						<tr class="bg-zinc-100 text-left text-[10px] uppercase tracking-wide text-zinc-500">
							<th class="rounded-l-xl px-4 py-3">Products</th>
							<th class="px-4 py-3">Jan</th>
							<th class="px-4 py-3">Feb</th>
							<th class="px-4 py-3">Mar</th>
							<th class="px-4 py-3">Apr</th>
							<th class="px-4 py-3">May</th>
							<th class="px-4 py-3">June</th>
							<th class="px-4 py-3">July</th>
							<th class="px-4 py-3">Aug</th>
							<th class="px-4 py-3">Sept</th>
							<th class="rounded-r-xl px-4 py-3">Oct</th>
						</tr>
					</thead>
					<tbody id="monthly-1"></tbody>
				</table>
			</div>
		</div>
		<div class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
			<div class="flex items-center justify-between">
				<p class="text-sm font-semibold">Monthly Sales Profit 2025</p>
				<button class="text-zinc-400">⋮</button>
			</div>
			<div class="mt-3 overflow-x-auto">
				<table class="min-w-full text-xs">
					<thead>
						<tr class="bg-zinc-100 text-left text-[10px] uppercase tracking-wide text-zinc-500">
							<th class="rounded-l-xl px-4 py-3">Products</th>
							<th class="px-4 py-3">Jan</th>
							<th class="px-4 py-3">Feb</th>
							<th class="px-4 py-3">Mar</th>
							<th class="px-4 py-3">Apr</th>
							<th class="px-4 py-3">May</th>
							<th class="px-4 py-3">June</th>
							<th class="px-4 py-3">July</th>
							<th class="px-4 py-3">Aug</th>
							<th class="px-4 py-3">Sept</th>
							<th class="rounded-r-xl px-4 py-3">Oct</th>
						</tr>
					</thead>
					<tbody id="monthly-2"></tbody>
				</table>
			</div>
		</div>
		<div class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
			<div class="flex items-center justify-between">
				<p class="text-sm font-semibold">Monthly Sales Profit 2025</p>
				<button class="text-zinc-400">⋮</button>
			</div>
			<div class="mt-3 overflow-x-auto">
				<table class="min-w-full text-xs">
					<thead>
						<tr class="bg-zinc-100 text-left text-[10px] uppercase tracking-wide text-zinc-500">
							<th class="rounded-l-xl px-4 py-3">Products</th>
							<th class="px-4 py-3">Jan</th>
							<th class="px-4 py-3">Feb</th>
							<th class="px-4 py-3">Mar</th>
							<th class="px-4 py-3">Apr</th>
							<th class="px-4 py-3">May</th>
							<th class="px-4 py-3">June</th>
							<th class="px-4 py-3">July</th>
							<th class="px-4 py-3">Aug</th>
							<th class="px-4 py-3">Sept</th>
							<th class="rounded-r-xl px-4 py-3">Oct</th>
						</tr>
					</thead>
					<tbody id="monthly-3"></tbody>
				</table>
			</div>
		</div>
		<div class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
			<div class="flex items-center justify-between">
				<p class="text-sm font-semibold">Monthly Sales Profit 2025</p>
				<button class="text-zinc-400">⋮</button>
			</div>
			<div class="mt-3 overflow-x-auto">
				<table class="min-w-full text-xs">
					<thead>
						<tr class="bg-zinc-100 text-left text-[10px] uppercase tracking-wide text-zinc-500">
							<th class="rounded-l-xl px-4 py-3">Products</th>
							<th class="px-4 py-3">Jan</th>
							<th class="px-4 py-3">Feb</th>
							<th class="px-4 py-3">Mar</th>
							<th class="px-4 py-3">Apr</th>
							<th class="px-4 py-3">May</th>
							<th class="px-4 py-3">June</th>
							<th class="px-4 py-3">July</th>
							<th class="px-4 py-3">Aug</th>
							<th class="px-4 py-3">Sept</th>
							<th class="rounded-r-xl px-4 py-3">Oct</th>
						</tr>
					</thead>
					<tbody id="monthly-4"></tbody>
				</table>
			</div>
		</div>
		<div class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
			<div class="flex items-center justify-between">
				<p class="text-sm font-semibold">Monthly Sales Profit 2025</p>
				<button class="text-zinc-400">⋮</button>
			</div>
			<div class="mt-3 overflow-x-auto">
				<table class="min-w-full text-xs">
					<thead>
						<tr class="bg-zinc-100 text-left text-[10px] uppercase tracking-wide text-zinc-500">
							<th class="rounded-l-xl px-4 py-3">Products</th>
							<th class="px-4 py-3">Jan</th>
							<th class="px-4 py-3">Feb</th>
							<th class="px-4 py-3">Mar</th>
							<th class="px-4 py-3">Apr</th>
							<th class="px-4 py-3">May</th>
							<th class="px-4 py-3">June</th>
							<th class="px-4 py-3">July</th>
							<th class="px-4 py-3">Aug</th>
							<th class="px-4 py-3">Sept</th>
							<th class="rounded-r-xl px-4 py-3">Oct</th>
						</tr>
					</thead>
					<tbody id="monthly-5"></tbody>
				</table>
			</div>
		</div>
		<div class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm">
			<div class="flex items-center justify-between">
				<p class="text-sm font-semibold">Monthly Sales Profit 2025</p>
				<button class="text-zinc-400">⋮</button>
			</div>
			<div class="mt-3 overflow-x-auto">
				<table class="min-w-full text-xs">
					<thead>
						<tr class="bg-zinc-100 text-left text-[10px] uppercase tracking-wide text-zinc-500">
							<th class="rounded-l-xl px-4 py-3">Products</th>
							<th class="px-4 py-3">Jan</th>
							<th class="px-4 py-3">Feb</th>
							<th class="px-4 py-3">Mar</th>
							<th class="px-4 py-3">Apr</th>
							<th class="px-4 py-3">May</th>
							<th class="px-4 py-3">June</th>
							<th class="px-4 py-3">July</th>
							<th class="px-4 py-3">Aug</th>
							<th class="px-4 py-3">Sept</th>
							<th class="rounded-r-xl px-4 py-3">Oct</th>
						</tr>
					</thead>
					<tbody id="monthly-6"></tbody>
				</table>
			</div>
		</div>
	</div>

	<script type="module">
		import { fetchProducts, fetchCustomersSearch, fetchCategoriesSearch, fetchSales, formatRupiah } from "/admin-api.js";

		const setText = (id, text) => {
			const el = document.getElementById(id);
			if (el) el.textContent = String(text);
		};

		const showError = (message) => {
			const el = document.getElementById("dash-error");
			if (!el) return;
			el.textContent = message;
			el.classList.remove("hidden");
		};

		function renderMonthly(tbodyId, items, seed = 0) {
			const tbody = document.getElementById(tbodyId);
			if (!tbody) return;
			tbody.innerHTML = "";
			for (let i = 0; i < items.length; i++) {
				const name = items[i];
				const base = [3, 9, 7, 6, 5, 3, 19, 17, 11, 22];
				const nums = base.map((n, idx) => Math.max(0, n - ((seed + i + idx) % 3)));
				const tr = document.createElement("tr");
				tr.innerHTML = `
					<td class="border-b border-zinc-100 px-4 py-3">${name}</td>
					<td class="border-b border-zinc-100 px-4 py-3">${nums[0]}</td>
					<td class="border-b border-zinc-100 px-4 py-3">${nums[1]}</td>
					<td class="border-b border-zinc-100 px-4 py-3">${nums[2]}</td>
					<td class="border-b border-zinc-100 px-4 py-3">${nums[3]}</td>
					<td class="border-b border-zinc-100 px-4 py-3">${nums[4]}</td>
					<td class="border-b border-zinc-100 px-4 py-3">${nums[5]}</td>
					<td class="border-b border-zinc-100 px-4 py-3">${nums[6]}</td>
					<td class="border-b border-zinc-100 px-4 py-3">${nums[7]}</td>
					<td class="border-b border-zinc-100 px-4 py-3">${nums[8]}</td>
					<td class="border-b border-zinc-100 px-4 py-3">${nums[9]}</td>
				`;
				tbody.appendChild(tr);
			}
		}

		(async () => {
			try {
				const [products, customers, categories, sales, best] = await Promise.all([
					fetchProducts({ limit: 500 }),
					fetchCustomersSearch(),
					fetchCategoriesSearch(),
					fetchSales(),
					fetchProducts({ bestSelling: true, limit: 10 }),
				]);

				const revenue = sales.reduce((sum, s) => sum + Number(s.total || 0), 0);
				const sold = sales.reduce((sum, s) => sum + (Array.isArray(s.items) ? s.items.reduce((a, it) => a + Number(it.qty || 0), 0) : 0), 0);

				setText("stat-revenue", formatRupiah(revenue));
				setText("stat-sales", sales.length);
				setText("stat-sold", sold);
				setText("stat-profit", formatRupiah(revenue));

				const bestBody = document.getElementById("best-body");
				bestBody.innerHTML = "";
				const bestRows = (best && best.length ? best : products.slice(0, 10)).slice(0, 10);
				bestRows.forEach((p, idx) => {
					const tr = document.createElement("tr");
					tr.innerHTML = `
						<td class="border-b border-zinc-100 px-4 py-3">${p.name}</td>
						<td class="border-b border-zinc-100 px-4 py-3 text-right text-zinc-500">${idx + 1}</td>
					`;
					bestBody.appendChild(tr);
				});

				const fallbackNames = ["Pulpen Gel", "Pulpen Ball", "Pensil", "Buku Tulis", "Penghapus", "Spidol", "Penggaris"];
				const names = (bestRows.map((p) => p.name).filter(Boolean).length ? bestRows.map((p) => p.name) : fallbackNames).slice(0, 10);
				const groups = [
					names.slice(0, 4),
					names.slice(1, 5),
					names.slice(2, 6),
					names.slice(3, 7),
					names.slice(4, 8),
					names.slice(0, 4).map((n) => `GENESIS ${n}`),
				];
				renderMonthly("monthly-1", groups[0].filter(Boolean), 0);
				renderMonthly("monthly-2", groups[1].filter(Boolean), 1);
				renderMonthly("monthly-3", groups[2].filter(Boolean), 2);
				renderMonthly("monthly-4", groups[3].filter(Boolean), 3);
				renderMonthly("monthly-5", groups[4].filter(Boolean), 4);
				renderMonthly("monthly-6", groups[5].filter(Boolean), 5);
			} catch (e) {
				showError(e?.message ?? String(e));
			}
		})();
	</script>
</AdminLayout>
