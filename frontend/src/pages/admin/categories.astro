---
import AdminLayout from "../../layouts/AdminLayout.astro";
---

<AdminLayout title="Categories" active="categories">
	<div class="flex items-center justify-between">
		<h1 class="text-lg font-semibold">Kategori</h1>
		<div class="flex items-center gap-3">
			<div class="rounded-xl border border-zinc-200 bg-white px-4 py-2">
				<p class="text-[10px] text-zinc-500">Jumlah kategori</p>
				<div class="mt-0.5 flex items-center gap-2">
					<div class="grid h-7 w-7 place-items-center rounded-full bg-red-50 text-red-600">
						<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M20 7h-9" />
							<path d="M14 17H5" />
							<circle cx="17" cy="17" r="3" />
							<circle cx="7" cy="7" r="3" />
						</svg>
					</div>
					<p id="stat" class="text-base font-semibold leading-none">-</p>
				</div>
			</div>
			<button id="btn-add" class="inline-flex items-center gap-2 rounded-xl border border-zinc-200 bg-white px-4 py-2 text-[13px] font-semibold hover:bg-zinc-50">
				<span class="grid h-7 w-7 place-items-center rounded-full bg-red-50 text-red-600">
					<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M12 5v14" />
						<path d="M5 12h14" />
					</svg>
				</span>
				Tambah Kategori
			</button>
		</div>
	</div>

	<div class="mt-4">
		<div class="relative">
			<svg class="pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-zinc-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<circle cx="11" cy="11" r="8" />
				<path d="M21 21l-4.3-4.3" />
			</svg>
			<input id="q" class="h-10 w-full rounded-xl border border-zinc-200 bg-white pl-10 pr-3 text-sm" placeholder="Cari kategori..." />
		</div>

		<div id="grid" class="mt-5 grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
		<p id="empty" class="mt-4 hidden text-sm text-zinc-500">Belum ada data.</p>
		<p id="error" class="mt-4 hidden text-sm text-red-600"></p>
	</div>

	<dialog id="dlg" class="w-full max-w-xl rounded-2xl p-0">
		<form method="dialog" class="rounded-2xl bg-white">
			<div class="border-b border-zinc-200 px-5 py-4">
				<p id="dlg-title" class="text-sm font-semibold">Tambah Category</p>
				<p class="text-xs text-zinc-500">Edit = hapus + tambah (bisa gagal jika kategori dipakai produk).</p>
			</div>
			<div class="grid gap-3 px-5 py-4 sm:grid-cols-2">
				<label class="text-sm">
					<span class="text-xs text-zinc-600">ID (2 karakter)</span>
					<input name="id" required minlength="2" maxlength="2" class="mt-1 w-full rounded-lg border border-zinc-200 px-3 py-2 text-sm" />
				</label>
				<label class="text-sm sm:col-span-2">
					<span class="text-xs text-zinc-600">Nama</span>
					<input name="name" required class="mt-1 w-full rounded-lg border border-zinc-200 px-3 py-2 text-sm" />
				</label>
			</div>
			<input type="hidden" name="__mode" value="create" />
			<input type="hidden" name="__originalId" value="" />
			<p id="form-error" class="px-5 pb-2 text-sm text-red-600"></p>
			<div class="flex items-center justify-end gap-2 border-t border-zinc-200 px-5 py-4">
				<button type="button" data-cancel class="rounded-lg border border-zinc-200 bg-white px-4 py-2 text-sm hover:bg-zinc-50">Batal</button>
				<button type="submit" class="rounded-lg bg-zinc-900 px-4 py-2 text-sm font-medium text-white hover:bg-zinc-800">Simpan</button>
			</div>
		</form>
	</dialog>

	<script type="module">
		import { fetchCategoriesSearch, createCategory, deleteCategory } from "/admin-api.js";

		const grid = document.getElementById("grid");
		const emptyEl = document.getElementById("empty");
		const errEl = document.getElementById("error");
		const qEl = document.getElementById("q");
		const dlg = document.getElementById("dlg");
		const formErr = document.getElementById("form-error");
		const statEl = document.getElementById("stat");
		const dlgTitle = document.getElementById("dlg-title");
		let categoriesById = new Map();

		const ICON_PENCIL = `
			<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M12 20h9" />
				<path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z" />
			</svg>
		`;
		const ICON_TRASH = `
			<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<path d="M3 6h18" />
				<path d="M8 6V4h8v2" />
				<path d="M19 6l-1 14H6L5 6" />
				<path d="M10 11v6" />
				<path d="M14 11v6" />
			</svg>
		`;

		function showError(message) {
			errEl.textContent = message;
			errEl.classList.remove("hidden");
		}
		function clearError() {
			errEl.textContent = "";
			errEl.classList.add("hidden");
		}

		function closestFromEvent(e, selector) {
			const t = e?.target;
			const el = t && t.nodeType === 3 ? t.parentElement : t;
			return el && el.closest ? el.closest(selector) : null;
		}

		function renderRows(rows) {
			grid.innerHTML = "";
			categoriesById = new Map(rows.map((c) => [c.id, c]));
			statEl.textContent = String(rows.length);

			for (const c of rows) {
				const card = document.createElement("div");
				card.className = "rounded-2xl border border-zinc-200 bg-white p-4 shadow-sm";
				card.innerHTML = `
					<div class="flex items-start gap-3">
						<div class="grid h-10 w-10 place-items-center rounded-xl bg-red-500 text-white">
							<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path d="M20 7h-9" />
								<path d="M14 17H5" />
								<circle cx="17" cy="17" r="3" />
								<circle cx="7" cy="7" r="3" />
							</svg>
						</div>
						<div class="min-w-0">
							<p class="text-[11px] font-semibold uppercase tracking-wide text-zinc-900">${c.name}</p>
							<div class="mt-2 flex items-center gap-4 text-[11px]">
								<button data-del="${c.id}" class="text-blue-600 hover:underline">Hapus</button>
								<button data-edit="${c.id}" class="text-blue-600 hover:underline">Edit</button>
							</div>
						</div>
					</div>
				`;
				grid.appendChild(card);
			}

			const addCard = document.createElement("button");
			addCard.type = "button";
			addCard.id = "add-card";
			addCard.className = "rounded-2xl border border-zinc-200 bg-white p-4 text-left shadow-sm hover:bg-zinc-50";
			addCard.innerHTML = `
				<div class="grid h-10 w-10 place-items-center rounded-xl bg-red-500 text-white">
					<svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M12 5v14" />
						<path d="M5 12h14" />
					</svg>
				</div>
				<p class="mt-3 text-sm font-semibold">Tambah Kategori</p>
			`;
			grid.appendChild(addCard);

			emptyEl.classList.toggle("hidden", rows.length !== 0);
		}

		async function load() {
			clearError();
			const q = String(qEl.value || "").trim();
			try {
				const rows = await fetchCategoriesSearch(q ? { q } : undefined);
				renderRows(rows);
			} catch (e) {
				showError(e?.message ?? String(e));
			}
		}

		qEl.addEventListener("input", () => load());
		qEl.addEventListener("keydown", (e) => {
			if (e.key === "Enter") load();
		});

		document.getElementById("btn-add").addEventListener("click", () => {
			dlgTitle.textContent = "Tambah Category";
			formErr.textContent = "";
			dlg.querySelector('input[name="__mode"]').value = "create";
			dlg.querySelector('input[name="__originalId"]').value = "";
			dlg.showModal();
		});

		dlg.querySelector("[data-cancel]")?.addEventListener("click", () => {
			formErr.textContent = "";
			dlg.close("cancel");
		});

		dlg.addEventListener("close", () => {
			formErr.textContent = "";
			dlgTitle.textContent = "Tambah Category";
			const form = dlg.querySelector("form");
			form?.reset();
			const mode = dlg.querySelector('input[name="__mode"]');
			const originalId = dlg.querySelector('input[name="__originalId"]');
			if (mode) mode.value = "create";
			if (originalId) originalId.value = "";
		});

		dlg.querySelector("form").addEventListener("submit", async (e) => {
			e.preventDefault();
			formErr.textContent = "";
			const fd = new FormData(e.currentTarget);
			const mode = String(fd.get("__mode") || "create");
			const originalId = String(fd.get("__originalId") || "").trim();
			const input = {
				id: String(fd.get("id") || "").trim(),
				name: String(fd.get("name") || "").trim(),
			};
			try {
				if (mode === "edit" && originalId) {
					await deleteCategory(originalId);
				}
				await createCategory(input);
				dlg.close();
				await load();
			} catch (err) {
				formErr.textContent = err?.message ?? String(err);
			}
		});

		grid.addEventListener("click", async (e) => {
			const addCard = closestFromEvent(e, "#add-card");
			if (addCard) {
				dlgTitle.textContent = "Tambah Category";
				formErr.textContent = "";
				dlg.querySelector('input[name="__mode"]').value = "create";
				dlg.querySelector('input[name="__originalId"]').value = "";
				dlg.showModal();
				return;
			}

			const delBtn = closestFromEvent(e, "button[data-del]");
			if (delBtn) {
				const id = delBtn.getAttribute("data-del");
				if (!id) return;
				if (!confirm(`Hapus category ${id}?`)) return;
				try {
					await deleteCategory(id);
					await load();
				} catch (err) {
					showError(err?.message ?? String(err));
				}
				return;
			}

			const editBtn = closestFromEvent(e, "button[data-edit]");
			if (editBtn) {
				const id = editBtn.getAttribute("data-edit");
				if (!id) return;
				const c = categoriesById.get(id);
				if (!c) return;
				dlgTitle.textContent = "Edit Category";
				formErr.textContent = "";
				dlg.querySelector('input[name="__mode"]').value = "edit";
				dlg.querySelector('input[name="__originalId"]').value = id;
				dlg.querySelector('input[name="id"]').value = c.id;
				dlg.querySelector('input[name="name"]').value = c.name;
				dlg.showModal();
			}
		});

		load();
	</script>
</AdminLayout>
