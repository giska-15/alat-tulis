---
import Layout from "../layouts/Layout.astro";
import Icons from "../components/Icons.astro";
import ProductCard from "../components/ProductCard.astro";
import SiteTopBar from "../components/SiteTopBar.astro";
import SiteHeader from "../components/SiteHeader.astro";
import SiteFooter from "../components/SiteFooter.astro";
import { fetchHome } from "../lib/api";
import { formatRupiah } from "../lib/api";
import { fallbackProductImage, imgOnErrorTo } from "../lib/image";
import type { HomePayload } from "../lib/api";
import type { Product } from "../lib/api";

const emptyHome: HomePayload = {
	categories: [],
	bestSelling: [],
	explore: [],
	newArrival: [],
	themeCategoryId: "AT",
};

const data: HomePayload = await fetchHome().catch(() => emptyHome);

type NewArrivalProduct = HomePayload["newArrival"][number];
const featured0 = (data.newArrival[0] ?? null) as NewArrivalProduct | null;
const featured1 = (data.newArrival[1] ?? null) as NewArrivalProduct | null;
const featured2to4 = data.newArrival.slice(2, 4) as NewArrivalProduct[];
const tiles: Array<NewArrivalProduct | null> = featured2to4.length
	? featured2to4
	: ([null, null] as Array<NewArrivalProduct | null>);

type NavItem = { label: string; href: string };

const defaultSidebar: NavItem[] = [
	{ label: "Pensil", href: "/products?q=pensil" },
	{ label: "Pulpen Gel Pen", href: "/products?q=pulpen" },
	{ label: "Gunting", href: "/products?q=gunting" },
	{ label: "Spidol", href: "/products?q=spidol" },
	{ label: "Cutter", href: "/products?q=cutter" },
	{ label: "Penghapus", href: "/products?q=penghapus" },
	{ label: "Tip Ex / Correction", href: "/products?q=correction" },
	{ label: "Staples / Stapler", href: "/products?q=stap" },
	{ label: "Highlighter", href: "/products?q=highlighter" },
];

const sidebarLinks: NavItem[] = data.categories.length
	? data.categories.slice(0, 9).map((c) => ({ label: c.name, href: `/categories/${c.id}` }))
	: defaultSidebar;

const browseLinks: NavItem[] = data.categories.length
	? data.categories.map((c) => ({ label: c.name, href: `/categories/${c.id}` }))
	: [
			{ label: "Pensil", href: "/products?q=pensil" },
			{ label: "Pulpen", href: "/products?q=pulpen" },
			{ label: "Buku", href: "/products?q=buku" },
			{ label: "Spidol", href: "/products?q=spidol" },
			{ label: "Penggaris", href: "/products?q=penggaris" },
			{ label: "Stapler", href: "/products?q=stapler" },
		];

const flashSales = data.explore.slice(0, 5);
const exploreProducts = data.explore.slice(0, 8);
const bestSelling = data.bestSelling.slice(0, 4);

// Live countdown target (keeps the same UI, but updates in real time).
// Set to ~3 days 23:19:56 from now to match the mock values closely.
const flashSaleEndsAt = new Date(Date.now() + (3 * 24 * 60 * 60 + 23 * 60 * 60 + 19 * 60 + 56) * 1000);

function discountPercent(product: Product): number {
	const steps = [40, 35, 30, 25, 20];
	return steps[Math.abs(product.id) % steps.length] ?? 25;
}

function discountedPrice(product: Product): number {
	const pct = discountPercent(product);
	return Math.max(0, Math.round(product.price * (100 - pct) / 100));
}
---

<Layout title="Exclusive | Alat Tulis">
	<div id="top" class="bg-white text-zinc-900">
		<SiteTopBar />
		<SiteHeader active="home" accountName="Mirza" />

		<main class="mx-auto max-w-6xl px-4">
			<section class="grid grid-cols-1 gap-6 py-8 md:grid-cols-12 md:py-10">
				<aside class="md:col-span-3">
					<div class="border-r border-zinc-100 pr-6">
						<p class="text-sm font-semibold text-zinc-900">Exclusive</p>
						<ul class="mt-4 space-y-3 text-sm text-zinc-700">
						{sidebarLinks.map((c) => (
							<li>
								<a class="block hover:text-zinc-900" href={c.href}>{c.label}</a>
							</li>
						))}
						</ul>
					</div>
				</aside>

				<div class="md:col-span-9">
					<div class="relative overflow-hidden rounded bg-black">
						<div class="grid grid-cols-1 items-center gap-6 p-7 md:grid-cols-2 md:p-10">
							<div class="text-white">
								<p class="text-sm text-white/70">stationery items</p>
								<h1 class="mt-3 text-4xl font-semibold leading-tight md:text-5xl">Up to 10%<br />off Voucher</h1>
								<a href="#flash" class="mt-6 inline-flex items-center gap-2 text-sm font-medium text-white/90 hover:text-white">
									Shop Now <span aria-hidden="true">→</span>
								</a>
								<div class="mt-6 flex gap-2">
									{[0, 1, 2, 3, 4].map((i) => (
										<span class={"h-2 w-2 rounded-full " + (i === 2 ? "bg-red-500" : "bg-white/30")} />
									))}
								</div>
							</div>
							<div class="hidden md:block">
								<div class="grid h-64 w-full place-items-center rounded bg-black">
									<svg viewBox="0 0 520 260" class="h-56 w-full max-w-[420px]" fill="none" xmlns="http://www.w3.org/2000/svg">
										<rect x="24" y="28" width="472" height="204" rx="18" fill="#0B0B0B" />
										<path d="M326 176c0 14-11 26-26 26H190c-14 0-26-12-26-26v-74c0-14 12-26 26-26h110c15 0 26 12 26 26v74Z" fill="#111827" stroke="#374151" />
										<path d="M188 112h116l-12 48H200l-12-48Z" fill="#0F172A" stroke="#4B5563" />
										<circle cx="216" cy="182" r="10" fill="#111827" stroke="#9CA3AF" />
										<circle cx="298" cy="182" r="10" fill="#111827" stroke="#9CA3AF" />
										<path d="M348 86l44-18 10 24-44 18-10-24Z" fill="#EF4444" />
										<path d="M348 150l56-8 4 26-56 8-4-26Z" fill="#22C55E" />
										<path d="M114 88l58 12-6 28-58-12 6-28Z" fill="#60A5FA" />
										<path d="M114 154l44-20 10 22-44 20-10-22Z" fill="#F59E0B" />
										<text x="56" y="70" fill="#9CA3AF" font-size="12" font-family="ui-sans-serif, system-ui">BACK TO SCHOOL</text>
									</svg>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>

			<hr class="my-12 border-zinc-100" />

			<section id="flash" class="py-2">
				<div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
					<div>
						<div class="flex items-center gap-2">
							<span class="inline-block h-6 w-3 rounded bg-red-500"></span>
							<p class="text-xs font-semibold text-red-500">Today’s</p>
						</div>
						<div class="mt-2 flex flex-col gap-4 md:flex-row md:items-end">
							<h2 class="text-3xl font-semibold">Flash Sales</h2>
							<div
								class="flex items-center gap-4 text-center"
								data-countdown
								data-to={flashSaleEndsAt.toISOString()}
							>
								<div>
									<p class="text-[10px] font-semibold text-zinc-500">Days</p>
									<p class="text-lg font-semibold" data-dd>03</p>
								</div>
								<div>
									<p class="text-[10px] font-semibold text-zinc-500">Hours</p>
									<p class="text-lg font-semibold" data-hh>23</p>
								</div>
								<div>
									<p class="text-[10px] font-semibold text-zinc-500">Minutes</p>
									<p class="text-lg font-semibold" data-mm>19</p>
								</div>
								<div>
									<p class="text-[10px] font-semibold text-zinc-500">Seconds</p>
									<p class="text-lg font-semibold" data-ss>56</p>
								</div>
							</div>
						</div>
					</div>
					<div class="flex items-center gap-2">
						<button class="grid h-10 w-10 place-items-center rounded-full bg-zinc-50 ring-1 ring-zinc-200 hover:bg-white" type="button" aria-label="Prev" data-carousel-prev="flash">
							<Icons name="chev-left" class="h-4 w-4" />
						</button>
						<button class="grid h-10 w-10 place-items-center rounded-full bg-zinc-50 ring-1 ring-zinc-200 hover:bg-white" type="button" aria-label="Next" data-carousel-next="flash">
							<Icons name="chev-right" class="h-4 w-4" />
						</button>
					</div>
				</div>

				<div class="mt-6 flex gap-4 overflow-x-auto pb-2 no-scrollbar snap-x snap-mandatory" data-carousel="flash">
					{flashSales.map((p) => (
						<article
							class="group min-w-[220px] max-w-[220px] snap-start md:min-w-[230px] md:max-w-[230px]"
							data-product={
								JSON.stringify({
									id: p.id,
									name: p.name,
									slug: p.slug,
									price: p.price,
									stock: p.stock,
									imageUrl: p.imageUrl,
									category: p.category,
								})
							}
						>
							<div class="relative overflow-hidden rounded bg-zinc-50 ring-1 ring-zinc-100">
								<span class="absolute left-3 top-3 rounded bg-red-500 px-2 py-1 text-[11px] font-semibold text-white">-{discountPercent(p)}%</span>
								<div class="absolute right-2 top-2 flex flex-col gap-2">
									<button class="grid h-8 w-8 place-items-center rounded-full bg-white/90 text-zinc-700 shadow ring-1 ring-zinc-200 hover:text-red-500" type="button" aria-label="Wishlist" data-action="toggle-wishlist" data-wishlist-state={String(p.id)}>
										<Icons name="heart" class="h-4 w-4" />
									</button>
									<button class="grid h-8 w-8 place-items-center rounded-full bg-white/90 text-zinc-700 shadow ring-1 ring-zinc-200 hover:text-zinc-900" type="button" aria-label="Quick view">
										<Icons name="eye" class="h-4 w-4" />
									</button>
								</div>
								<a class="block aspect-[4/3] bg-white" href={`/products/${p.id}`} aria-label={`Lihat ${p.name}`}>
									<img
										src={p.imageUrl || fallbackProductImage(p.id, p.name, p.category?.id)}
										alt={p.name}
										class="h-full w-full object-cover"
										loading="lazy"
										decoding="async"
										onerror={imgOnErrorTo(fallbackProductImage(p.id, p.name, p.category?.id))}
									/>
								</a>
								<button class="absolute inset-x-0 bottom-0 translate-y-full bg-black py-2 text-center text-sm font-medium text-white transition group-hover:translate-y-0" type="button" data-action="add-to-cart">Add To Cart</button>
							</div>
							<div class="mt-3 space-y-1">
								<p class="line-clamp-2 text-sm font-medium">{p.name}</p>
								<p class="text-sm text-red-500">
									{formatRupiah(discountedPrice(p))}
									<span class="ml-2 text-xs text-zinc-400 line-through">{formatRupiah(p.price)}</span>
								</p>
								<div class="flex items-center gap-2">
									<span class="text-[11px] text-amber-400">★★★★★</span>
									<span class="text-[11px] text-zinc-500">(88)</span>
								</div>
							</div>
						</article>
					))}
				</div>

				<div class="mt-8 flex justify-center">
					<a href="/products" class="rounded bg-red-500 px-8 py-3 text-sm font-semibold text-white hover:bg-red-600">View All Products</a>
				</div>
			</section>

			<hr class="my-12 border-zinc-100" />

			<section class="py-2">
				<div class="flex items-center justify-between">
					<div>
						<div class="flex items-center gap-2">
							<span class="inline-block h-6 w-3 rounded bg-red-500"></span>
							<p class="text-xs font-semibold text-red-500">Categories</p>
						</div>
						<h2 class="mt-2 text-3xl font-semibold">Browse By Category</h2>
					</div>
					<div class="flex items-center gap-2">
						<button class="grid h-10 w-10 place-items-center rounded-full bg-zinc-50 ring-1 ring-zinc-200 hover:bg-white" type="button" aria-label="Prev" data-carousel-prev="browse">
							<Icons name="chev-left" class="h-4 w-4" />
						</button>
						<button class="grid h-10 w-10 place-items-center rounded-full bg-zinc-50 ring-1 ring-zinc-200 hover:bg-white" type="button" aria-label="Next" data-carousel-next="browse">
							<Icons name="chev-right" class="h-4 w-4" />
						</button>
					</div>
				</div>
				<div class="mt-6 flex gap-4 overflow-x-auto pb-2 no-scrollbar snap-x snap-mandatory cursor-grab select-none" data-carousel="browse">
					{browseLinks.map((c, idx) => (
						<a
							href={c.href}
							class="group grid aspect-square min-w-[160px] place-items-center gap-3 rounded border border-zinc-200 bg-white p-5 text-center text-sm text-zinc-700 transition snap-start hover:border-red-500 hover:bg-red-500 hover:text-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500 focus-visible:ring-offset-2 active:bg-red-600 md:min-w-[170px]"
						>
							{(() => {
								switch (idx) {
									case 0:
										return (
											<svg viewBox="0 0 24 24" class="h-8 w-8" fill="none" stroke="currentColor" stroke-width="1.6">
												<rect x="7" y="2.5" width="10" height="19" rx="2" />
													<path d="M10 19h4" />
											</svg>
										);
									case 1:
										return (
											<svg viewBox="0 0 24 24" class="h-8 w-8" fill="none" stroke="currentColor" stroke-width="1.6">
												<rect x="3" y="4" width="18" height="12" rx="2" />
												<path d="M8 20h8" />
												<path d="M12 16v4" />
											</svg>
										);
									case 2:
										return (
											<svg viewBox="0 0 24 24" class="h-8 w-8" fill="none" stroke="currentColor" stroke-width="1.6">
												<rect x="7" y="2.5" width="10" height="19" rx="3" />
												<path d="M9 7h6" />
												<path d="M9 11h6" />
											</svg>
										);
									case 3:
										return (
											<svg viewBox="0 0 24 24" class="h-8 w-8" fill="none" stroke="currentColor" stroke-width="1.6">
												<path d="M7 7h10l2 3v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V10l2-3Z" />
												<circle cx="12" cy="13" r="3" />
											</svg>
										);
									case 4:
										return (
											<svg viewBox="0 0 24 24" class="h-8 w-8" fill="none" stroke="currentColor" stroke-width="1.6">
												<path d="M6 12a6 6 0 1 1 12 0" />
												<path d="M4 12h2" />
												<path d="M18 12h2" />
												<path d="M7 14v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-5" />
											</svg>
										);
									default:
										return (
											<svg viewBox="0 0 24 24" class="h-8 w-8" fill="none" stroke="currentColor" stroke-width="1.6">
												<path d="M7 12h10" />
												<path d="M12 7v10" />
												<rect x="4" y="4" width="16" height="16" rx="4" />
											</svg>
										);
							}
							})()}
							<span class="line-clamp-2">{c.label}</span>
						</a>
					))}
				</div>
			</section>

			<hr class="my-12 border-zinc-100" />

			<section class="py-2">
				<div class="flex items-center justify-between">
					<div>
						<div class="flex items-center gap-2">
							<span class="inline-block h-6 w-3 rounded bg-red-500"></span>
							<p class="text-xs font-semibold text-red-500">This Month</p>
						</div>
						<h2 class="mt-2 text-3xl font-semibold">Best Selling Products</h2>
					</div>
					<a href="/products" class="rounded bg-red-500 px-6 py-3 text-sm font-semibold text-white hover:bg-red-600">View All</a>
				</div>
				<div class="mt-6 grid grid-cols-2 gap-6 md:grid-cols-4">
					{bestSelling.map((p) => (
						<ProductCard product={p} />
					))}
				</div>
			</section>

			<section class="mt-10 rounded bg-black">
				<div class="grid grid-cols-1 items-center gap-8 p-8 md:grid-cols-2 md:p-10">
					<div class="text-white">
						<p class="text-xs font-semibold uppercase tracking-wider text-green-400">Categories</p>
						<h3 class="mt-3 text-3xl font-semibold leading-tight">Enhance Your<br />Draw Experience</h3>
						<div class="mt-6 flex gap-3">
							{["23", "05", "59", "35"].map((v, i) => (
								<div class="grid h-12 w-12 place-items-center rounded-full bg-white text-zinc-900" title={["Hours", "Days", "Minutes", "Seconds"][i]}>
									<span class="text-sm font-semibold">{v}</span>
								</div>
							))}
						</div>
						<a href="/products" class="mt-6 inline-flex rounded bg-green-500 px-6 py-3 text-sm font-semibold text-black hover:bg-green-400">Buy Now!</a>
					</div>
					<div class="hidden md:block">
						<img
							src="https://images.unsplash.com/photo-1588072432904-843af37f03ed?auto=format&fit=crop&w=1400&q=60"
							alt="Promo"
							class="h-72 w-full rounded object-cover"
							loading="lazy"
						/>
					</div>
				</div>
			</section>

			<hr class="my-12 border-zinc-100" />

			<section id="products" class="py-2">
				<div class="flex items-center justify-between">
					<div>
						<div class="flex items-center gap-2">
							<span class="inline-block h-6 w-3 rounded bg-red-500"></span>
							<p class="text-xs font-semibold text-red-500">Our Products</p>
						</div>
						<h2 class="mt-2 text-3xl font-semibold">Explore Our Products</h2>
					</div>
					<div class="flex items-center gap-2">
						<button class="grid h-10 w-10 place-items-center rounded-full bg-zinc-50 ring-1 ring-zinc-200 hover:bg-white" type="button" aria-label="Prev" data-carousel-prev="explore">
							<Icons name="chev-left" class="h-4 w-4" />
						</button>
						<button class="grid h-10 w-10 place-items-center rounded-full bg-zinc-50 ring-1 ring-zinc-200 hover:bg-white" type="button" aria-label="Next" data-carousel-next="explore">
							<Icons name="chev-right" class="h-4 w-4" />
						</button>
					</div>
				</div>
				<div class="mt-6 hidden grid-cols-2 gap-6 md:grid md:grid-cols-4">
					{exploreProducts.map((p) => (<ProductCard product={p} />))}
				</div>
				<div class="mt-6 flex gap-4 overflow-x-auto pb-2 no-scrollbar snap-x snap-mandatory md:hidden" data-carousel="explore">
					{exploreProducts.map((p) => (
						<div class="min-w-[220px] max-w-[220px] snap-start">
							<ProductCard product={p} />
						</div>
					))}
				</div>
				<div class="mt-8 flex justify-center">
					<a href="/products" class="rounded bg-red-500 px-8 py-3 text-sm font-semibold text-white hover:bg-red-600">View All Products</a>
				</div>
			</section>

			<hr class="my-12 border-zinc-100" />

			<section class="py-2">
				<div>
					<div class="flex items-center gap-2">
						<span class="inline-block h-6 w-3 rounded bg-red-500"></span>
						<p class="text-xs font-semibold text-red-500">Featured</p>
					</div>
					<h2 class="mt-2 text-3xl font-semibold">New Arrival</h2>
				</div>

				<div class="mt-6 grid grid-cols-1 gap-4 md:grid-cols-2 md:grid-rows-2">
					<article class="relative min-h-[22rem] overflow-hidden rounded bg-black md:row-span-2 md:min-h-[32rem]">
						<div class="absolute inset-0 p-8 md:p-10">
							<img
								src={
									featured0?.imageUrl ??
									"https://images.unsplash.com/photo-1505678261036-a3fcc5e884ee?auto=format&fit=crop&w=1400&q=60"
								}
								alt={featured0?.name ?? "New Arrival"}
								class="h-full w-full object-contain"
								loading="lazy"
							/>
						</div>
						<div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/10 to-transparent"></div>
						<div class="absolute inset-0 flex flex-col justify-end p-6 text-white">
							<p class="text-lg font-semibold">{featured0?.name ?? "Spidol Whiteboard"}</p>
							<p class="mt-1 max-w-[18rem] text-sm text-white/70">Produk baru untuk kebutuhan sekolah & kantor.</p>
							<a href={featured0 ? `/products/${featured0.id}` : "/products"} class="mt-3 w-fit text-sm font-medium underline underline-offset-4 text-white/90 hover:text-white">Shop Now</a>
						</div>
					</article>

					<article class="relative min-h-[12rem] overflow-hidden rounded bg-black md:col-start-2 md:row-start-1">
						<div class="absolute inset-0 grid grid-cols-2 items-center p-6">
							<div class="pr-3 text-white">
								<p class="text-base font-semibold">{featured1?.name ?? "Pensil Heksagonal Deli"}</p>
								<p class="mt-1 text-sm text-white/70">Pensil gambar & menulis untuk siswa.</p>
								<a href={featured1 ? `/products/${featured1.id}` : "/products"} class="mt-3 inline-flex text-sm font-medium underline underline-offset-4 text-white/90 hover:text-white">Shop Now</a>
							</div>
							<div class="pl-3">
								<img
									src={
										featured1?.imageUrl ??
										"https://images.unsplash.com/photo-1588072432904-843af37f03ed?auto=format&fit=crop&w=1400&q=60"
									}
									alt={featured1?.name ?? "New Arrival"}
									class="h-40 w-full object-contain"
									loading="lazy"
								/>
							</div>
						</div>
					</article>

					<div class="grid grid-cols-1 gap-4 md:col-start-2 md:row-start-2 md:grid-cols-2">
						{tiles.map((p) => (
							<article class="relative min-h-[12rem] overflow-hidden rounded bg-black">
								<div class="absolute inset-0 p-6">
									<img
										src={
											p?.imageUrl ??
											"https://images.unsplash.com/photo-1529070538774-1843cb3265df?auto=format&fit=crop&w=1400&q=60"
									}
										alt={p?.name ?? "New Arrival"}
										class="h-full w-full object-contain"
										loading="lazy"
									/>
								</div>
								<div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/10 to-transparent"></div>
								<div class="absolute inset-0 flex flex-col justify-end p-5 text-white">
									<p class="text-base font-semibold">{p?.name ?? "Highlighter Marker"}</p>
									<a href={p ? `/products/${p.id}` : "/products"} class="mt-2 w-fit text-sm font-medium underline underline-offset-4 text-white/90 hover:text-white">Shop Now</a>
								</div>
							</article>
						))}
					</div>
				</div>

				<div class="mt-12 grid grid-cols-1 gap-10 md:grid-cols-3">
					<div class="text-center">
						<div class="mx-auto grid h-16 w-16 place-items-center rounded-full bg-zinc-200">
							<div class="grid h-12 w-12 place-items-center rounded-full bg-black text-white">
								<svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 7h13l3 5v5h-2"/><path d="M3 7v10h10"/><circle cx="7" cy="19" r="1.5"/><circle cx="17" cy="19" r="1.5"/></svg>
							</div>
						</div>
						<p class="mt-4 text-sm font-semibold">FREE AND FAST DELIVERY</p>
						<p class="mt-1 text-xs text-zinc-500">Free delivery for all orders over Rp 50.000</p>
					</div>
					<div class="text-center">
						<div class="mx-auto grid h-16 w-16 place-items-center rounded-full bg-zinc-200">
							<div class="grid h-12 w-12 place-items-center rounded-full bg-black text-white">
								<svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 12a8 8 0 1 1 16 0"/><path d="M2 12h4"/><path d="M18 12h4"/><path d="M8 19h8"/><path d="M12 15v4"/></svg>
							</div>
						</div>
						<p class="mt-4 text-sm font-semibold">24/7 CUSTOMER SERVICE</p>
						<p class="mt-1 text-xs text-zinc-500">Friendly 24/7 customer support</p>
					</div>
					<div class="text-center">
						<div class="mx-auto grid h-16 w-16 place-items-center rounded-full bg-zinc-200">
							<div class="grid h-12 w-12 place-items-center rounded-full bg-black text-white">
								<svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 2l8 4v6c0 5-3.5 9-8 10-4.5-1-8-5-8-10V6l8-4Z"/><path d="M9 12l2 2 4-5"/></svg>
							</div>
						</div>
						<p class="mt-4 text-sm font-semibold">MONEY BACK GUARANTEE</p>
						<p class="mt-1 text-xs text-zinc-500">We return money within 30 days</p>
					</div>
				</div>
			</section>
		</main>

		<SiteFooter />

		<a
			href="#top"
			class="fixed bottom-6 right-6 grid h-10 w-10 place-items-center rounded-full bg-white text-zinc-700 shadow ring-1 ring-zinc-200 hover:bg-zinc-50"
			aria-label="Back to top"
		>
			<svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.8">
				<path d="M12 5l-6 6h4v8h4v-8h4l-6-6Z" />
			</svg>
		</a>
	</div>
</Layout>

<script is:inline>
	(() => {
		const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
		const pad2 = (n) => String(Math.max(0, Math.floor(n))).padStart(2, "0");

		const setupCarousel = (name) => {
			const track = document.querySelector(`[data-carousel="${name}"]`);
			if (!(track instanceof HTMLElement)) return;
			const prev = document.querySelector(`[data-carousel-prev="${name}"]`);
			const next = document.querySelector(`[data-carousel-next="${name}"]`);
			if (!(prev instanceof HTMLButtonElement) || !(next instanceof HTMLButtonElement)) return;

			// Drag-to-scroll (mouse/finger) to make horizontal scrolling obvious.
			let isDown = false;
			let didDrag = false;
			let startX = 0;
			let startY = 0;
			let startLeft = 0;
			let pointerId = null;
			const DRAG_THRESHOLD = 6;

			const isInteractive = (evTarget) => {
				if (!(evTarget instanceof Element)) return false;
				return Boolean(evTarget.closest('a,button,input,select,textarea,[data-action]'));
			};

			const onDown = (e) => {
				if (!(e instanceof PointerEvent)) return;
				// Don't hijack clicks on buttons/links inside the carousel.
				if (isInteractive(e.target)) return;
				isDown = true;
				didDrag = false;
				pointerId = e.pointerId;
				startX = e.clientX;
				startY = e.clientY;
				startLeft = track.scrollLeft;
			};
			const onMove = (e) => {
				if (!isDown || !(e instanceof PointerEvent)) return;
				const dx = e.clientX - startX;
				const dy = e.clientY - startY;

				// Only start dragging after passing a small threshold.
				if (!didDrag) {
					if (Math.abs(dx) < DRAG_THRESHOLD || Math.abs(dx) < Math.abs(dy)) return;
					didDrag = true;
					try {
						if (pointerId != null) track.setPointerCapture(pointerId);
					} catch {}
					track.classList.add("cursor-grabbing");
				}

				e.preventDefault();
				track.scrollLeft = startLeft - dx;
			};
			const onUp = () => {
				isDown = false;
				pointerId = null;
				track.classList.remove("cursor-grabbing");
			};
			track.addEventListener("pointerdown", onDown);
			track.addEventListener("pointermove", onMove);
			track.addEventListener("pointerup", onUp);
			track.addEventListener("pointercancel", onUp);
			track.addEventListener(
				"click",
				(e) => {
					// If we just dragged, suppress the click that would otherwise block buttons/links.
					if (!didDrag) return;
					e.preventDefault();
					e.stopPropagation();
					didDrag = false;
				},
				true
			);

			const step = () => {
				const first = track.firstElementChild;
				if (!(first instanceof HTMLElement)) return Math.floor(track.clientWidth * 0.9);
				const style = window.getComputedStyle(track);
				const gap = Number.parseFloat(style.columnGap || style.gap || "0") || 0;
				return Math.max(180, Math.floor(first.getBoundingClientRect().width + gap));
			};

			const scrollBy = (dir) => {
				track.scrollBy({ left: dir * step(), behavior: "smooth" });
			};

			prev.addEventListener("click", () => scrollBy(-1));
			next.addEventListener("click", () => scrollBy(1));

			// Enable/disable arrows based on scroll position.
			const update = () => {
				const maxLeft = track.scrollWidth - track.clientWidth;
				const left = clamp(track.scrollLeft, 0, Math.max(0, maxLeft));
				prev.disabled = left <= 2;
				next.disabled = maxLeft <= 2 ? true : left >= maxLeft - 2;
				prev.classList.toggle("opacity-40", prev.disabled);
				next.classList.toggle("opacity-40", next.disabled);
			};
			update();
			track.addEventListener("scroll", () => requestAnimationFrame(update), { passive: true });
			window.addEventListener("resize", () => requestAnimationFrame(update));
		};

		setupCarousel("flash");
		setupCarousel("browse");
		setupCarousel("explore");

		const nodes = document.querySelectorAll("[data-countdown][data-to]");
		for (const root of nodes) {
			const to = root.getAttribute("data-to");
			const end = to ? Date.parse(to) : NaN;
			if (!Number.isFinite(end)) continue;

			const dd = root.querySelector("[data-dd]");
			const hh = root.querySelector("[data-hh]");
			const mm = root.querySelector("[data-mm]");
			const ss = root.querySelector("[data-ss]");

			const tick = () => {
				const now = Date.now();
				let diff = Math.max(0, end - now);
				const totalSeconds = Math.floor(diff / 1000);
				const days = Math.floor(totalSeconds / 86400);
				const hours = Math.floor((totalSeconds % 86400) / 3600);
				const minutes = Math.floor((totalSeconds % 3600) / 60);
				const seconds = totalSeconds % 60;

				if (dd) dd.textContent = pad2(days);
				if (hh) hh.textContent = pad2(hours);
				if (mm) mm.textContent = pad2(minutes);
				if (ss) ss.textContent = pad2(seconds);
			};

			tick();
			setInterval(tick, 1000);
		}
	})();
</script>
