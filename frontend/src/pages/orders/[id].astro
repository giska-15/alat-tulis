---
import Layout from "../../layouts/Layout.astro";
import SiteTopBar from "../../components/SiteTopBar.astro";
import SiteHeader from "../../components/SiteHeader.astro";
import SiteFooter from "../../components/SiteFooter.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";

const { id } = Astro.params;
---

<Layout title={`Detail Pesanan #${id} | Exclusive`}>
	<div id="top" class="bg-white text-zinc-900">
		<SiteTopBar />
		<SiteHeader active="none" accountName="Mirza" />

		<main class="mx-auto max-w-6xl px-4">
			<section class="py-8">
				<Breadcrumbs items={[{ label: "Home", href: "/" }, { label: "My Orders", href: "/orders" }, { label: `Order #${id}` }]} />

				<div class="mt-10 rounded bg-white p-8 ring-1 ring-zinc-200">
					<div class="flex flex-col gap-2 md:flex-row md:items-start md:justify-between">
						<div>
							<h1 class="text-2xl font-semibold">Detail Pesanan</h1>
							<p class="mt-1 text-sm text-zinc-600">Ringkasan invoice, resi, dan item pesanan.</p>
						</div>
						<a href="/orders" class="mt-3 inline-flex w-fit rounded border border-zinc-300 px-4 py-2 text-sm font-semibold hover:bg-zinc-50 md:mt-0">Kembali</a>
					</div>

					<div class="mt-8 grid grid-cols-1 gap-6 md:grid-cols-2">
						<div class="rounded border border-zinc-200 p-5">
							<p class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Invoice</p>
							<p class="mt-2 text-lg font-semibold" data-invoice>-</p>
						</div>
						<div class="rounded border border-zinc-200 p-5">
							<p class="text-xs font-semibold uppercase tracking-wide text-zinc-500">Nomor Resi</p>
							<p class="mt-2 text-lg font-semibold" data-resi>-</p>
						</div>
					</div>

					<div class="mt-6 rounded bg-zinc-50 p-5 ring-1 ring-zinc-200">
						<div class="grid grid-cols-1 gap-3 text-sm md:grid-cols-2">
							<div class="flex items-center justify-between gap-4">
								<span class="text-zinc-600">Order ID</span>
								<span class="font-semibold" data-orderid>-</span>
							</div>
							<div class="flex items-center justify-between gap-4">
								<span class="text-zinc-600">Tanggal</span>
								<span class="font-semibold" data-date>-</span>
							</div>
							<div class="flex items-center justify-between gap-4">
								<span class="text-zinc-600">Total</span>
								<span class="font-semibold" data-total>-</span>
							</div>
							<div class="flex items-center justify-between gap-4">
								<span class="text-zinc-600">Status</span>
								<span class="font-semibold" data-status>Diproses</span>
							</div>
						</div>
					</div>

					<div class="mt-8">
						<h2 class="text-lg font-semibold">Item</h2>
						<div class="mt-4 overflow-x-auto rounded border border-zinc-200">
							<table class="w-full min-w-[720px] text-left text-sm">
								<thead class="border-b border-zinc-100 bg-zinc-50 text-zinc-600">
									<tr>
										<th class="px-5 py-3 font-semibold">Produk</th>
										<th class="px-5 py-3 font-semibold">Harga</th>
										<th class="px-5 py-3 font-semibold">Qty</th>
										<th class="px-5 py-3 font-semibold">Subtotal</th>
									</tr>
								</thead>
								<tbody data-items>
									<tr>
										<td class="px-5 py-6 text-sm text-zinc-600" colspan="4">Memuat item...</td>
									</tr>
								</tbody>
							</table>
						</div>
						<p class="mt-4 hidden text-sm text-red-600" data-error></p>
					</div>
				</div>
			</section>
		</main>

		<SiteFooter />

		<script define:vars={{ ORDER_ID: id }} is:inline>
			const invEl = document.querySelector('[data-invoice]');
			const resiEl = document.querySelector('[data-resi]');
			const idEl = document.querySelector('[data-orderid]');
			const dateEl = document.querySelector('[data-date]');
			const totalEl = document.querySelector('[data-total]');
			const itemsEl = document.querySelector('[data-items]');
			const errEl = document.querySelector('[data-error]');

			const formatRupiah = (n) => {
				try {
					return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(Number(n || 0));
				} catch {
					return 'Rp ' + Number(n || 0).toLocaleString('id-ID');
				}
			};

			const getTracking = (orderId) => {
				try {
					const raw = localStorage.getItem('exclusive_tracking_by_order');
					const map = raw ? JSON.parse(raw) : {};
					return map && orderId != null ? map[String(orderId)] || null : null;
				} catch {
					return null;
				}
			};

			async function loadDetail() {
				try {
					const customerId = localStorage.getItem('exclusive_customer_id');
					if (!customerId) throw new Error('Belum ada pesanan untuk akun ini. Silakan checkout dulu.');

					const res = await fetch(`/api/sales/${encodeURIComponent(String(ORDER_ID))}`, { headers: { Accept: 'application/json' } });
					const json = await res.json().catch(() => null);
					if (!res.ok) throw new Error(json?.error?.message || `Request failed: ${res.status}`);
					const o = json?.data;
					if (!o) throw new Error('Data pesanan tidak ditemukan');
					if (String(o?.customerId || '') !== String(customerId)) throw new Error('Pesanan ini bukan milik akun kamu.');

					const invoice = o?.receiptNumber || (o?.id != null ? `INV-${o.id}` : '-');
					const resi = o?.trackingNumber || getTracking(o?.id);
					if (invEl) invEl.textContent = invoice;
					if (resiEl) resiEl.textContent = resi || '-';
					if (idEl) idEl.textContent = o?.id != null ? String(o.id) : '-';
					if (dateEl) dateEl.textContent = o?.orderDate ? new Date(o.orderDate).toLocaleString('id-ID') : '-';
					if (totalEl) totalEl.textContent = formatRupiah(o?.total || 0);

					if (itemsEl instanceof HTMLElement) {
						const items = Array.isArray(o?.items) ? o.items : [];
						itemsEl.innerHTML = '';
						if (!items.length) {
							itemsEl.innerHTML = '<tr><td class="px-5 py-6 text-sm text-zinc-600" colspan="4">Tidak ada item.</td></tr>';
							return;
						}
						items.forEach((it) => {
							const name = it?.product?.name || `Produk #${it?.productId}`;
							const price = Number(it?.price || 0);
							const qty = Number(it?.qty || 0);
							const subtotal = price * qty;
							const tr = document.createElement('tr');
							tr.className = 'border-b border-zinc-100 last:border-0';
							tr.innerHTML = `
								<td class="px-5 py-4 font-medium">${name}</td>
								<td class="px-5 py-4">${formatRupiah(price)}</td>
								<td class="px-5 py-4">${qty}</td>
								<td class="px-5 py-4 font-semibold">${formatRupiah(subtotal)}</td>
							`;
							itemsEl.appendChild(tr);
						});
					}
				} catch (e) {
					if (errEl instanceof HTMLElement) {
						errEl.textContent = e?.message || 'Gagal memuat detail pesanan.';
						errEl.classList.remove('hidden');
					}
					if (itemsEl instanceof HTMLElement) {
						itemsEl.innerHTML = '<tr><td class="px-5 py-6 text-sm text-zinc-600" colspan="4">Gagal memuat item.</td></tr>';
					}
				}
			}

			loadDetail();
		</script>
	</div>
</Layout>
